{% extends "base.html" %}

{% block title %}Campaigns - Iron Lady Newsletter{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="text-white">
            <i class="fas fa-paper-plane"></i> Email Campaigns
        </h1>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addCampaignModal">
            <i class="fas fa-plus"></i> New Campaign
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-list"></i> All Campaigns
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Campaign Name</th>
                        <th>Template</th>
                        <th>Status</th>
                        <th>Recipients</th>
                        <th>Scheduled/Sent</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="campaignsTable">
                    <tr>
                        <td colspan="7" class="text-center text-muted">Loading campaigns...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Campaign Modal -->
<div class="modal fade" id="addCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCampaignForm">
                    <div class="mb-3">
                        <label class="form-label">Campaign Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Template *</label>
                        <select class="form-select" name="template_id" id="templateSelect" required>
                            <option value="">Loading templates...</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> You can send the campaign immediately or schedule it for later after creation.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCampaign()">
                    <i class="fas fa-save"></i> Create Campaign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> Schedule Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">
                    <div class="mb-3">
                        <label class="form-label">Schedule Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="scheduleDate" required>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> The campaign will be automatically sent at the scheduled time.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="scheduleCampaign()">
                    <i class="fas fa-clock"></i> Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let campaigns = [];
    let templates = [];
    const addModal = new bootstrap.Modal(document.getElementById('addCampaignModal'));
    const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    
    async function loadTemplates() {
        try {
            const response = await axios.get('/api/templates');
            templates = response.data;
            
            const select = document.getElementById('templateSelect');
            if (templates.length === 0) {
                select.innerHTML = '<option value="">No templates available. Create one first!</option>';
            } else {
                select.innerHTML = '<option value="">Select a template</option>' + 
                    templates.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading templates:', error);
        }
    }
    
    async function loadCampaigns() {
        try {
            const response = await axios.get('/api/campaigns');
            campaigns = response.data;
            renderCampaigns();
        } catch (error) {
            console.error('Error loading campaigns:', error);
        }
    }
    
    function renderCampaigns() {
        const tableBody = document.getElementById('campaignsTable');
        
        if (campaigns.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No campaigns yet</td></tr>';
            return;
        }
        
        tableBody.innerHTML = campaigns.map(campaign => {
            const template = templates.find(t => t.id === campaign.template_id);
            const templateName = template ? template.title : 'Unknown';
            
            return `
                <tr>
                    <td>${campaign.id}</td>
                    <td>${campaign.name}</td>
                    <td>${templateName}</td>
                    <td><span class="badge bg-${getStatusColor(campaign.status)}">${campaign.status}</span></td>
                    <td>${campaign.recipients_count || 0}</td>
                    <td>${campaign.sent_date || campaign.scheduled_date || '-'}</td>
                    <td>
                        ${campaign.status === 'draft' ? `
                            <button class="btn btn-sm btn-success" onclick="sendCampaignNow(${campaign.id})">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="showSchedule(${campaign.id})">
                                <i class="fas fa-clock"></i> Schedule
                            </button>
                        ` : ''}
                        ${campaign.status === 'sent' ? `
                            <span class="text-success"><i class="fas fa-check-circle"></i> Sent</span>
                        ` : ''}
                        ${campaign.status === 'scheduled' ? `
                            <button class="btn btn-sm btn-info" onclick="sendCampaignNow(${campaign.id})">
                                <i class="fas fa-fast-forward"></i> Send Now
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCampaign(${campaign.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function getStatusColor(status) {
        const colors = {
            'draft': 'secondary',
            'scheduled': 'warning',
            'sent': 'success'
        };
        return colors[status] || 'secondary';
    }
    
    async function addCampaign() {
        const form = document.getElementById('addCampaignForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        if (!data.template_id) {
            alert('Please select a template');
            return;
        }
        
        try {
            await axios.post('/api/campaigns', data);
            addModal.hide();
            form.reset();
            loadCampaigns();
            showAlert('Campaign created successfully!', 'success');
        } catch (error) {
            console.error('Error adding campaign:', error);
            alert('Failed to create campaign');
        }
    }
    
    async function sendCampaignNow(id) {
        if (!confirm('Are you sure you want to send this campaign to all active subscribers?')) return;
        
        try {
            showAlert('Sending campaign... This may take a moment.', 'info');
            const response = await axios.post(`/api/campaigns/${id}/send`);
            loadCampaigns();
            showAlert(response.data.message, 'success');
        } catch (error) {
            console.error('Error sending campaign:', error);
            alert('Failed to send campaign. Check email configuration.');
        }
    }
    
    function showSchedule(id) {
        document.getElementById('scheduleId').value = id;
        
        // Set default to tomorrow at 9 AM
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        document.getElementById('scheduleDate').value = tomorrow.toISOString().slice(0, 16);
        
        scheduleModal.show();
    }
    
    async function scheduleCampaign() {
        const id = document.getElementById('scheduleId').value;
        const scheduledDate = document.getElementById('scheduleDate').value;
        
        if (!scheduledDate) {
            alert('Please select a date and time');
            return;
        }
        
        try {
            await axios.put(`/api/campaigns/${id}`, {
                status: 'scheduled',
                scheduled_date: scheduledDate
            });
            scheduleModal.hide();
            loadCampaigns();
            showAlert('Campaign scheduled successfully!', 'success');
        } catch (error) {
            console.error('Error scheduling campaign:', error);
            alert('Failed to schedule campaign');
        }
    }
    
    async function deleteCampaign(id) {
        if (!confirm('Are you sure you want to delete this campaign?')) return;
        
        try {
            await axios.delete(`/api/campaigns/${id}`);
            loadCampaigns();
            showAlert('Campaign deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting campaign:', error);
            alert('Failed to delete campaign');
        }
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }
    
    // Load data on page load
    loadTemplates();
    loadCampaigns();
</script>
{% endblock %}
