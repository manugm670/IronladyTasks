{% extends "base.html" %}

{% block title %}Subscribers - Iron Lady Newsletter{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="text-white">
            <i class="fas fa-users"></i> Subscriber Management
        </h1>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addSubscriberModal">
            <i class="fas fa-user-plus"></i> Add New Subscriber
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-list"></i> All Subscribers
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Program Interest</th>
                        <th>Status</th>
                        <th>Joined Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subscribersTable">
                    <tr>
                        <td colspan="7" class="text-center text-muted">Loading subscribers...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Subscriber Modal -->
<div class="modal fade" id="addSubscriberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add New Subscriber</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSubscriberForm">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program Interest</label>
                        <select class="form-select" name="program_interest">
                            <option value="">Select Program</option>
                            <option value="LEP">Leadership Essentials Program (LEP)</option>
                            <option value="1-Crore Club">1-Crore Club</option>
                            <option value="100 Board Members">100 Board Members</option>
                            <option value="MBW">Master Business Warfare (MBW)</option>
                            <option value="Masterclass">Masterclass</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSubscriber()">
                    <i class="fas fa-save"></i> Add Subscriber
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subscriber Modal -->
<div class="modal fade" id="editSubscriberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Subscriber</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSubscriberForm">
                    <input type="hidden" name="id" id="editId">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" name="name" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" name="email" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program Interest</label>
                        <select class="form-select" name="program_interest" id="editProgramInterest">
                            <option value="">Select Program</option>
                            <option value="LEP">Leadership Essentials Program (LEP)</option>
                            <option value="1-Crore Club">1-Crore Club</option>
                            <option value="100 Board Members">100 Board Members</option>
                            <option value="MBW">Master Business Warfare (MBW)</option>
                            <option value="Masterclass">Masterclass</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="editStatus">
                            <option value="active">Active</option>
                            <option value="unsubscribed">Unsubscribed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateSubscriber()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let subscribers = [];
    const addModal = new bootstrap.Modal(document.getElementById('addSubscriberModal'));
    const editModal = new bootstrap.Modal(document.getElementById('editSubscriberModal'));
    
    async function loadSubscribers() {
        try {
            const response = await axios.get('/api/subscribers');
            subscribers = response.data;
            renderSubscribers();
        } catch (error) {
            console.error('Error loading subscribers:', error);
            alert('Failed to load subscribers');
        }
    }
    
    function renderSubscribers() {
        const tableBody = document.getElementById('subscribersTable');
        
        if (subscribers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No subscribers yet</td></tr>';
            return;
        }
        
        tableBody.innerHTML = subscribers.map(sub => `
            <tr>
                <td>${sub.id}</td>
                <td>${sub.name}</td>
                <td>${sub.email}</td>
                <td>${sub.program_interest || '-'}</td>
                <td><span class="badge bg-${sub.status === 'active' ? 'success' : 'secondary'}">${sub.status}</span></td>
                <td>${sub.created_at}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editSubscriber(${sub.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSubscriber(${sub.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    async function addSubscriber() {
        const form = document.getElementById('addSubscriberForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        try {
            await axios.post('/api/subscribers', data);
            addModal.hide();
            form.reset();
            loadSubscribers();
            showAlert('Subscriber added successfully!', 'success');
        } catch (error) {
            console.error('Error adding subscriber:', error);
            alert(error.response?.data?.error || 'Failed to add subscriber');
        }
    }
    
    function editSubscriber(id) {
        const subscriber = subscribers.find(s => s.id === id);
        if (!subscriber) return;
        
        document.getElementById('editId').value = subscriber.id;
        document.getElementById('editName').value = subscriber.name;
        document.getElementById('editEmail').value = subscriber.email;
        document.getElementById('editProgramInterest').value = subscriber.program_interest || '';
        document.getElementById('editStatus').value = subscriber.status;
        
        editModal.show();
    }
    
    async function updateSubscriber() {
        const form = document.getElementById('editSubscriberForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        const id = data.id;
        delete data.id;
        
        try {
            await axios.put(`/api/subscribers/${id}`, data);
            editModal.hide();
            loadSubscribers();
            showAlert('Subscriber updated successfully!', 'success');
        } catch (error) {
            console.error('Error updating subscriber:', error);
            alert('Failed to update subscriber');
        }
    }
    
    async function deleteSubscriber(id) {
        if (!confirm('Are you sure you want to delete this subscriber?')) return;
        
        try {
            await axios.delete(`/api/subscribers/${id}`);
            loadSubscribers();
            showAlert('Subscriber deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting subscriber:', error);
            alert('Failed to delete subscriber');
        }
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }
    
    // Load subscribers on page load
    loadSubscribers();
</script>
{% endblock %}
